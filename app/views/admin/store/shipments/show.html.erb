<% pmt = Payment.find_by(payable_type: :shipment, payable_id: @shipment.id) %>

<div class="dropdown pull-right">
  <a class="btn btn-default dropdown-toggle" data-toggle="dropdown" href="#">
    <i class="icon-hand-right"></i> Select Action
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <%= link_to edit_admin_store_shipment_path(@shipment) do %>
          <i class="fa fa-edit"></i> Edit
      <% end %>
    </li>
    <li>
      <%= link_to admin_store_shipments_product_labels_path(shipment_id: [@shipment.id]) do %>
          <i class="fa fa-print"></i> Product Labels
      <% end %>
    </li>
    <% if @shipment.invoice_amount > 0.0 %>
    <li>
      <%= link_to create_payment_admin_store_shipment_path(@shipment) do %>
          <i class="fa fa-file-o"></i> Post Invoice
      <% end %>
      <li>
        <%= link_to email_invoice_admin_store_shipment_path(@shipment) do %>
            <i class="fa fa-envelope"></i> Email Invoice
        <% end %>
      </li>
    </li>
    <% end %>
    <li>
      <%= link_to invoice_admin_store_shipment_path(@shipment), target: "_blank" do %>
          <i class="fa fa-print"></i> Print Invoice
      <% end %>
    </li>
    <li>
      <%= link_to packing_slip_admin_store_shipment_path(@shipment), target: "_blank" do %>
          <i class="fa fa-print"></i> Print Packing Slip
      <% end %>
    </li>
    <% if @shipment.items.length > 1 %>
    <li>
      <%= link_to scan_admin_store_shipment_path(@shipment) do %>
        <i class="fa fa-barcode"></i> Scan
      <% end %>
    </li>
    <% end %>
    <% if @shipment.status == "shipped" %>
    <li>
      <%= link_to email_confirmation_admin_store_shipment_path(@shipment) do %>
        <i class="fa fa-envelope"></i> Email tracking info
      <% end %>
    </li>
    <% end %>
    <li>
      <%= link_to admin_store_easy_post_path(shipment_id: @shipment.id) do %>
        <i class="fa fa-truck"></i> Get Rates and Ship
	    <% end %>
    </li>
  </ul>
</div>


<h2>
  <i class="fa fa-truck"></i> Shipment #<%= @shipment %> 
</h2>

<div class="pull-right">
  <% unless pmt.nil? %>
    <span class="label label-info">posted: <%= number_to_currency(pmt.amount * -1.0) %></span>
  <% else %>
    <span class="label label-warning">not posted</span>
  <% end %> &nbsp; 
  <span class="label label-success">invoice: <%= number_to_currency(@shipment.invoice_amount) %></span>
</div>
  
<div>
  <b>Created: </b> <%= time_ago_in_words(@shipment.created_at) %> ago
  &nbsp; <span class="label <%= 'label-warning' if @shipment.status == 'pending' %>  <%= 'label-success' if @shipment.status == 'shipped' %>"><%= @shipment.status %></span>
  &nbsp; <%= link_to admin_store_order_path(@shipment.order) do %>
    <i class="fa fa-shopping-cart"></i> View Order
  <% end %>
</div>

<hr style="margin-bottom: 20px;" />

<div class="row">

  <div class="col-md-4">
    <div class="panel panel-primary">
      <div class="panel-heading">Ship From:</div>
      <div class="panel-body">
        <%= @shipment.ship_from_company %><br/>
        <%= @shipment.ship_from_street1 %><br/>
        <%= raw @shipment.ship_from_street2 + '<br/>' unless @shipment.ship_from_street2.blank? %>
        <%= @shipment.ship_from_city %>, <%= @shipment.ship_from_state %> <%= @shipment.ship_from_zip %> <br/>
        <%= Country.find_country_by_alpha2(@shipment.ship_from_country) %>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="panel panel-primary">
      <div class="panel-heading">Recipient Address:</div>
      <div class="panel-body">
        <%= @shipment.recipient_name %><br/>
        <%= raw @shipment.recipient_company + '<br/>' unless @shipment.recipient_company.blank? %>
        <%= @shipment.recipient_street1 %><br/>
        <%= raw @shipment.recipient_street2 + '<br/>' unless @shipment.recipient_street2.blank? %>
        <%= @shipment.recipient_city %>, <%= @shipment.recipient_state %> <%= @shipment.recipient_zip %> <br/>
        <%= Country.find_country_by_alpha2(@shipment.recipient_country) %>
      </div>
    </div>

  </div>

  <div class="col-md-4">
    <div class="panel panel-primary">
      <div class="panel-heading">Notes:</div>
      <div class="panel-body">
        <%= @shipment.notes %>
      </div>
    </div>
  </div>

</div>


<% 
  upc_list = Upc.where(item: @shipment.order.items.collect { |x| x.item_number }) 
  item_count = @shipment.items.select { |x| x.quantity > 0 }.count
  total_qty = @shipment.items.map(&:quantity).reduce(:+)
%>

<h4>Items:</h4>
<table class="table table-striped table-condensed table-bordered">
    <tr>
        <th>Item</th>
        <th>Description</th>
        <th class="text-right">Ship Qty.</th>
        <th class="calign">Status</th>
    </tr>
    <% @shipment.items.each do |item| 
        upc = upc_list.find { |x| x.item == item.order_item.item_number } %>
        <tr>
            <td nowrap><%= item.order_item.item_number %></td>
            <td>
              <%= link_to item.product.full_name, admin_store_product_path(item.product_id) %>
              <% unless item.affiliate_id.nil? %>
                &nbsp; (<span><%= item.affiliate %></span>)
              <% end %>
              
              <% if upc && !upc.flags.include?("P") %>
                &nbsp; &nbsp; <i class="fa fa-camera" style="color: #d9534f;"></i>
              <% end %>
            </td>
            <td class="text-right"><%= number_with_delimiter(item.quantity) %></td>
            <td class="calign"><%= item.special_status %></td>
        </tr>
    <% end %>
    <tr>
      <th><%= pluralize item_count, "item" %></th>
      <th class="ralign">Total: </th>
      <th class="text-right"><%= number_with_delimiter(total_qty) %></th>
      <th></th>
    </tr>
</table>

<br/>


<% if @shipment.status == 'shipped' %>
	<div class="col-md-4" style="padding-left: 0;">
    <% unless @shipment.courier_data.nil? %>
		  <img width="100%" src="<%= label_image_admin_store_shipment_path(@shipment) %>" alt="label image"/>
    <% else %>
    <div style="color: #ccc; font-size: 24px; text-align: center; line-height: 150px; border: solid 1px #ccc;">
      Shipping Label not available
    </div>
    <% end %>
	</div>
	
	<div class="col-md-8" style="margin-bottom: 40px;">
	    <%= carrier_image @shipment.ship_method.split[0] unless @shipment.ship_method.blank? %>
	    <table class="table table-condensed table-bordered summary" style="margin-bottom: 10px;">
      <% unless @shipment.fulfilled_by_id.nil? %>
	      <tr>
	        <td class="key">Fulfilled by:</td>
	        <td><%= link_to @shipment.fulfiller, admin_system_user_path(@shipment.fulfiller) %></td>
	      </tr>
		  <% end %>
	      <tr>
	        <td class="key">Order #:</td>
	        <td><%= link_to @shipment.order_id.to_s, admin_store_order_path(@shipment.order_id) %></td>
	      </tr>
	      <tr>
	        <td class="key" width="160">Service Type:</td>
	        <td><%= @shipment.carrier %> <%= @shipment.ship_method %></td>
	      </tr>
	      <tr>
	        <td class="key">Ship Cost:</td>
	        <td><%= number_to_currency(@shipment.ship_cost) %></td>
	      </tr>
        <% unless @shipment.ship_date.nil? %>
	      <tr>
	        <td class="key">Ship Date:</td>
	        <td><%= @shipment.ship_date.strftime("%Y-%m-%d") %></td>
	      </tr>
        <% end %>
	      <tr>
	        <td class="key">Tracking:</td>
	        <td>
            <% unless @shipment.tracking_number.blank? %>
              <a href="<%= tracking_url(@shipment) %>" target="_new"><%= @shipment.tracking_number %></a>
            <% else %>
              n/a
            <% end %>
          </td>
	      </tr>
	      <tr>
	        <td class="key">Package Type:</td>
	        <td><%= @shipment.packaging_type %></td>
	      </tr>
	      <tr>
	        <td class="key">Weight:</td>
	        <td><%= @shipment.package_weight %> lb.</td>
	      </tr>
		  <% if @shipment.packaging_type == 'YOUR PACKAGING'%>
	      <tr>
	        <td class="key">Dimensions:</td>
	        <td><%= @shipment.package_length %>" x <%= @shipment.package_width %>" x <%= @shipment.package_height %>" </td>
	      </tr>
		  <% end %>
	      <tr>
	        <td class="key">Label Format:</td>
	        <td><%= @shipment.label_format %></td>
	      </tr>
	    </table>

    	<% unless @shipment.courier_data.nil? %>
  			<%= link_to "PDF",  label_admin_store_shipment_path(@shipment, format: 'pdf'), class: "btn btn-sm btn-default" %>
  			<%= link_to "EPL2", label_admin_store_shipment_path(@shipment, format: 'epl2'), class: "btn btn-sm btn-default" %>
  			<%= link_to "ZPL", label_admin_store_shipment_path(@shipment, format: 'zpl'), class: "btn btn-sm btn-default" %>
  			<% if @shipment.status == "shipped" && @shipment.carrier == 'USPS' && @shipment.ship_date > 1.month.ago %>
          <%= link_to "Void Shipment", void_label_admin_store_shipment_path(@shipment), class: "btn btn-sm btn-danger pull-right", data: { disable_with: "<i class='fa fa-spinner fa-spin'></i> please wait ..." }   %>
  			<% end %>
    	<% end %>
    </div>
    
<% else %>

  <div class="pull-right">
    <%= link_to admin_store_easy_post_path(shipment_id: @shipment.id), class: "btn btn-primary" do %>
      <i class="fa fa-arrow-right"></i> Get Rates and Ship
    <% end %>
  
    <form style="display: inline" method="post" action="/admin/store/shipments_update_status?status=shipped">
      <input name="authenticity_token" value="<%= form_authenticity_token %>" type="hidden">
      <input type="hidden" name="shipment_id[]" value="<%= @shipment.id %>"/>
      <button class="btn btn-success"><i class="fa fa-check"></i> Mark as shipped</button>
    </form>
  </div>
<% end %>

<pre>
<%= cookies.class %>

<%= cookies.inspect %>
</pre>


<% if @shipment.inventory_transaction.nil? %>
<div class="alert alert-warning">
  <i class="fa fa-exclamation-triangle"></i> There is no corresponding inventory transaction.  
  <%= link_to "Create one", create_inventory_transaction_admin_store_shipment_path(@shipment) %>
</div>
<% else %>

<div class="col-md-6 pull-left">
  
  <div class="panel panel-success">
    <div class="panel-heading">Inventory:</div>
    <div class="panel-body">
      <table class="table table-condensed small light">
        <tr>
          <th>Location</th>
          <th>SKU</th>
          <th>Name</th>
          <th class="text-center">Lot #</th>
          <th class="text-center">Exp.</th>
          <th class="text-right">Qty.</th>  
        </tr>
        <% @shipment.inventory_transaction.items.each do |item| %>
        <tr>
          <td class="text-center"><%= item.inventory_location.name %></td>
          <td><%= item.sku %></td>
          <td><%= Product.find_by(sku: item.sku).name_with_option %></td>
          <td class="text-center"><%= item.lot %></td>
          <td class="text-center"><%= item.formatted_expiration %></td>
          <td class="text-right"><%= number_with_delimiter(item.quantity.abs) %></td>
        </tr>
        <% end %>
      </table>
      <%= link_to "delete",
                  admin_inventory_inventory_transaction_path(@shipment.inventory_transaction),
                  method: :delete,
                  data: { confirm: "Are you sure? You will need to create a new inventory transaction before shipping this order." }, 
                  class: 'btn btn-danger btn-xs pull-right' %>
      <%= link_to "edit", edit_admin_inventory_inventory_transaction_path(@shipment.inventory_transaction), class: "btn btn-default btn-xs"%>
    </div>
  </div>
</div>

<% end %>



<% content_for :title do %>
    Shipment <%= @shipment.order_id %>-<%= @shipment.sequence %>
<% end %>





<% content_for :breadcrumbs do %>
    <li><a href="#">eCommerce</a></li>
    <li><%= link_to 'Shipments', admin_store_shipments_path(status: :pending) %></li>
    <li class="active"><%= @shipment %></li>
<% end %>
