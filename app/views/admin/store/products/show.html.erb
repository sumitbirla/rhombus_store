<style>
    .summary .label { font-weight: normal; margin-right: 6px; }
    .panel-body table { margin-bottom: 0;}
</style>

<% stock = InventoryItem.where(sku: @product.sku).sum(:quantity) %>
<div class="pull-right">
  <%= link_to "orders", admin_store_orders_path(status: :shipped, item_number: @product.item_number), class: "btn btn-sm btn-default" %>
  <%= link_to "clone", clone_admin_store_product_path(@product), class: "btn btn-sm btn-default" %>
  <%= link_to "edit", edit_admin_store_product_path(@product), class: "btn btn-sm btn-default" %>
</div>
<h2><i class="fa fa-tags"></i>&nbsp; <%= @product.name_with_option %></h2>
<h4>Item #: <%= @product.item_number %></h4>

<% if @product.template_product_id %>
<div class="alert alert-info">
  <b>Note: </b> This product's content is maintained by a template.  Changes made here may be overwritten.
  <b><%= link_to "Click here to edit template", admin_store_product_path(@product.template_product) %></b>.
</div>
<% end %>
<hr/>

<div class="row">
	<div class="col-md-8">

	<table class="table table-condensed table-bordered summary">
    <%= obj_property @product, :slug %>
    <%= obj_property(@product, :brand) { |x| link_to x.name, admin_store_products_path(brand_id: x.id) } %>
    <%= obj_property @product, :group %>
    
		<tr>
			<td>Price</td>
			<td>
        <span class="label label-default price">Web: $<%= @product.price %></span>
        <% unless @product.special_price.nil? %>
          <span class="label label-default price">Promo: $<%= @product.special_price %></span>
        <% end %>
        <% unless @product.retail_map.nil? %>
            <span class="label label-default price">MAP: $<%= @product.retail_map %></span>
        <% end %>
        <% unless @product.msrp.nil? %>
            <span class="label label-default price">MSRP: $<%= @product.msrp %></span>
        <% end %>
      </td>
		</tr>
    
    <%= obj_property(@product, :product_type) { |x| x.titlecase } %>
    <%= obj_property @product, :sku %>
    <%= obj_property @product, :upc %>
    <%= obj_property(@product, :fulfiller) { |x| link_to x.name, admin_system_affiliate_path(x.id) } %>
    <%= obj_property @product, :country_of_origin %>
    <%= obj_property @product, :harmonized_code %>
    <%= obj_property @product, :item_availability %>

    <% unless @product.item_weight.nil? %>
      <tr>
        <td>Item size</td>
        <td>
          <% unless @product.item_length.nil? %>
            <%= @product.item_length %>" x
            <%= @product.item_width %>" x
            <%= @product.item_height %>"
          <% end %>
          <b>&nbsp; (<%= @product.item_weight %> lbs.)</b>
        </td>
      </tr>
    <% end %>
    
    <% unless @product.case_weight.nil? %>
      <tr>
        <td>Case size</td>
        <td>
          <% unless @product.case_length.nil? %>
              <%= @product.case_length %>" x
              <%= @product.case_width %>" x
              <%= @product.case_height %>"
          <% end %>
          <b>&nbsp; (<%= @product.case_weight %> lbs.)</b>
          <i>&nbsp; &nbsp; <%= @product.case_quantity %> in a case</i>
        </td>
      </tr>
    <% end %>
    
    <%= obj_property(@product, :label_sheet) { |x| link_to x.name, edit_admin_store_label_sheet_path(x.id) } %>
    <%= obj_property @product, :warranty %>
    
    <tr>
      <td>Flags</td>
      <td>
        <% if @product.active %>
            <span class="label label-success">active</span>
        <% end %>
        <% if @product.hidden %>
            <span class="label label-warning">hidden</span>
        <% end %>

        <% if @product.free_shipping %>
            <span class="label label-info">free shipping</span>
        <% end %>

        <% if @product.tax_exempt %>
            <span class="label label-info">tax exempt</span>
        <% end %>

        <% if @product.require_image_upload %>
            <span class="label label-info">personalized</span>
        <% end %>
        
        <% if @product.auto_ship %>
            <span class="label label-info">auto ship</span>
        <% end %>

        <% if @product.featured %>
            <span class="label label-info">featured</span>
        <% end %>
        
        <% if @product.affiliate_only %>
            <span class="label label-warning">affiliate</span>
        <% end %>
        
        <% if @product.template %>
            <span class="label label-danger">template</span>
        <% end %>

        <% if !@product.low_threshold.nil? && stock <= @product.low_threshold %>
            <span class="label label-danger">low inventory</span>
        <% end %>
      </td>
    </tr>
	</table>
  
  <% unless @product.keywords.blank? %>
  <h4>Keywords</h4>
  <%= @product.keywords %>
  <hr>
  <% end %>



	<% if @product.coupons.length > 0 %>
	<h4>Coupons</h4>
	<table class="table table-condensed">
		<tr>
			<th>Code</th>
			<th>Discount</th>
			<th>Max uses</th>
			<th>Per user</th>
			<th>Times used</th>
			<th>Status</th>
		</tr>
		<% @product.coupons.each do |coupon| %>
		<tr>
			<td><%= link_to coupon.code, edit_admin_store_coupon_path(coupon, redirect: request.fullpath) %></td>
			<td>
				<% if !coupon.discount_percent.nil? %>
				<%= coupon.discount_percent.to_i %>%
				<% else %>
				<%= number_to_currency(coupon.discount_amount) %>
				<% end %>
			</td>
			<td><%= coupon.max_uses %></td>
			<td><%= coupon.max_per_user %></td>
			<td><%= coupon.times_used %></td>
			<td>
				<% if Time.now > coupon.start_time && Time.now < coupon.expire_time %>
				<span class="label label-success">active</span>
				<% elsif Time.now > coupon.expire_time %>
				<span class="label label-important">expired</span>
				<% else %>
				<span class="label label-warning">pending</span>
				<% end %>
			</td>
		</tr>
		<% end %>
	</table>
    <br/>
	<% end %>


	<% unless @product.short_description.blank? %>
		<h4 style="margin-top: 15px;">Short Description</h4>
		<%= @product.short_description %>
		<hr/>
	<% end %>


	<% unless @product.long_description.blank? %>
		<h4 style="margin-top: 15px;">Long Description</h4>
		<%= @product.long_description.gsub("\n", "<br/>").html_safe %>
	<% end %>
  
  <hr>
  <%= render partial: 'admin/shared/extra_properties', locals: { object: @product } %>
  
  <br/><br/>
</div>


<div class="col-md-4">
	<% if @product.pictures.length > 0 %>
      <h4>Pictures</h4>
      <a href="<%= cdn_image_url @product.pictures[0], 800, 700, 0 %>" data-lightbox="image-1">
          <img src="<%= cdn_image_url @product.pictures[0], 300, 300, 0 %>" title="<%= @product.pictures[0].caption %>" />
      </a>
      <% if @product.pictures.length > 1 %>
          <br/>
          <% @product.pictures[1..-1].each do |pic| %>
              <a href="<%= cdn_image_url pic, 700, 600, 0 %>"  data-lightbox="image-1">
                <img src="<%= cdn_image_url pic, 50, 50, 2 %>" class="img-thumbnail" style="margin: 4px" title="<%= pic.caption %>"/>
              </a>
          <% end %>
      <% end %>
    <hr/>
	<% end %>


  <% if @product.categories.length > 0 %>
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Categories</h3>
    </div>
    <div class="panel-body">
    	<ul>
    	<% @product.categories.each do |cat| %>
    	    <li><%= cat.name %></li>
    	<% end %>
    	</ul>
    </div>
  </div>
  <% end %>



  <% unless @product.group.blank?  %>
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Products in group:</h3>
    </div>
    <div class="panel-body">
      <table class="table table-condensed">
        <% 
          group = Product.where(group: @product.group, brand_id: @product.brand_id)
          if group.count > 20
            breed = @product.categories.find { |x| x.parent_id == 2 }   # breed
            group = group.joins(:categories).where("core_categories.id = ?", breed.id)
          end 
        %>
        <% group.order(:option_sort).each do |v| %>
            <tr>
              <td><%= link_to v.item_number, admin_store_product_path(v) %></td>
              <td><%= v.option_title %></td>
              <td class="ralign">$<%= v.price %></td>
            </tr>
        <% end %>
      </table>
    </div>
  </div>
  <% end %>
	
	

    <% unless @product.product_type == 'virtual' 
          inv_items = InventoryItem.includes(:inventory_location)
                               .where(sku: @product.sku)
                               .group(:inventory_location_id, :lot)
                               .order("expiration, quantity")
                               .select("lot, expiration, inventory_location_id, sum(quantity) as quantity")
    %>
    
    <% if inv_items.length > 0 %>
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title"><span class="pull-right light">Low: <%= @product.low_threshold %></span>Inventory</h3>
      </div>
      <div class="panel-body">
        <table class="table table-condensed">
        <% inv_items.each do |i| 
            next if i.quantity == 0 %>
          <tr>
            <td><%= i.inventory_location %></td>
            <td>lot# <%= i.lot %></td>
            <td>exp: <%= i.formatted_expiration %></td>
            <td class="text-right"><%= number_with_delimiter(i.quantity) %></td>
          </tr>
        <% end %>
        </table>
      </div>
    </div>
    <% end %>
    
    <%

      ap_list = AffiliateProduct.includes(:affiliate)
                                .joins(affiliate: :categories)
                                .where("core_categories.slug = 'suppliers'")
                                .where(product_id: @product) %>
    <% if ap_list.length > 0 %>
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">Suppliers</h3>
      </div>
      <div class="panel-body">
        <table class="table table-condensed">
        <% ap_list.each do |ap| %>
        <tr>
          <td><%= link_to ap.affiliate.name, admin_system_affiliate_path(ap.affiliate, q: :products) %></td>
          <td class="text-right"><%= number_to_currency(ap.price) %></td>
        </tr>
        <% end %>
        </table>
      </div>
    </div>
    <% end %>
    
    <i class="fa fa-info-circle"></i> 
    <%= link_to "see who purchased this item", admin_store_reports_product_sales_by_user_path(product_id: @product.id, start_date: 2.year.ago.to_date) %>
  <% end %>

</div>

</div>  <!-- row -->


<% content_for :title do %>
	Products: <%= @product.title %>
<% end %>


<% content_for :breadcrumbs do %>
	<li><a href="#">eCommerce</a></li>
	<li><%= link_to "Products", admin_store_products_path(brand_id: @product.brand_id) %></li>
	<li class="active"><%= @product.name_with_option %></li>
<% end %>
